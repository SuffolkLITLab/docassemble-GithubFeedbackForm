---
modules:
  - .github_issue
---
code: al_feedback_form_title = "Court Forms Online"  
---
code: |
  # This email will be used ONLY if there is no valid GitHub config
  al_error_email = get_config('error notification email')
---
id: interview order
mandatory: True
code: |
  intro
  if reason == 'bug':
    bug_details
    issue_template = bug_report
  elif reason == 'confusing':
    confusing_details
    issue_template = confusing_report
  elif reason == 'else':
    other_feedback
    issue_template = other_feedback_report
  elif reason == 'help':
    gentle_exit
  else:
    value(reason)  
    issue_template = generic_report[reason]
  send_to_github
  prevent_going_back()
  store_variables_snapshot(persistent=True)
  end_results
---
metadata:
  title: User Feedback
  exit url: |
    https://courtformsonline.org
---
image sets:
  freepik:
    attribution: |
      Icon made by [Freepik](http://www.flaticon.com/authors/freepik)
    images:
      opinion: opinion.svg
      bug: bug.svg
      confusion: confusion.svg
      lifebuoy: lifebuoy.svg
      love: love.svg
      enhancement: enhance.svg  
---
# This is the repository that Github issue will be created on if
# the repository is not passed as a URL argument
code: default_repository = 'docassemble-AssemblyLine'  
---
code: |
  default_github_user_or_organization = get_config('github issues',{}).get('default repository owner') or 'suffolklitlab'
---
code: |
  allowed_github_users = get_config('github issues',{}).get('allowed repository owners') or ["suffolklitlab","suffolklitlab-issues"]
---
features:
  labels above fields: True 
---
code: github_user = url_args.get('github_user', default_github_user_or_organization) or "suffolklitlab-issues"
---
code: github_repo = url_args.get('github_repo', default_repository) or "demo"
---
code: variable = url_args.get('variable')
---
code: question_id = url_args.get('question_id')
---
code: package_version = url_args.get('package_version')
---
code: filename = url_args.get('filename')
---
id: intro
question: |
  ${ al_feedback_form_title } - Tell us how we're doing
subquestion: |
  The information you type here will be publicly available. That means anyone
  will be able to see it. Use this form to tell us about problems that do not
  include any personal information.
  
  ${ al_how_to_get_legal_help }

  Thank you for telling us about your experience with this website.
  
fields:
  - "**What would you like to tell us about?**": reason
    input type: radio
    choices:
      - I found a bug: bug
      - Part of the form was confusing: confusing
      - I'd like to tell you something else: else
      - I'm looking for more help: help      
continue button field: intro  
---
if: |
  get_config('debug')
id: intro
question: |
  Tester feedback form
decoration: opinion  
subquestion: |
  You accessed a form on a server in "debug" or test mode.
  This form is designed to be used by testers and community
  stakeholders. 
  
  The information you type here will be publicly available. That means anyone
  will be able to see it. 
  
  ${ al_how_to_get_legal_help }
  
  It helps us to know how to prioritize your feedback. We use
  a [5-level 
  rating](https://suffolklitlab.org/legal-tech-class/docs/legal-tech-overview/maturity-model/#example-maturity-model-for-the-massaccess-project)
  for our finished forms. Forms are usually 
  ready to publish when they meet level 1, but all kinds of
  feedback are valuable. Some forms will reach level 2-5 through 
  iterative revision. Some will stay at level 1. Categorizing feedback
  helps us choose the right tasks to work on in the right order.
  
  #### Description of levels
  1. A user is able to correctly fill in the full form, like the paper form.
      * 1.5 Eliminates compound question. First pass at plain language.
  2. Similar to an intake with a new attorney
  3. Similar to an intake with an experienced attorney
  4. Provides substantial help and tailored resources in addition
  to filling in the form.
fields:
  - "**What would you like to tell us about?**": reason
    input type: radio
    choices:
      - Bug: bug
      - Language fix: language
      - Logic error: logic
      - Confusing user experience: confusing
      - Proposed enhancement: enhancement
      - I have something else to tell you: else
continue button field: intro  
---
variable name: maturity_levels
data:
  - Level 1 - this needs to be fixed to be equivalent to the blank form
  - Level 1.5 - it works as-is, but this is a significant plain language issue
  - Level 2 - this needs to be fixed to meet expectations of a basic intake
  - Level 3 - this needs to be fixed to meet expectations of a sophisticated intake worker
  - Level 4 - this is purely an enhancement to improve user experience
---
id: language fix
question: |
  Tell us about the language fix
decoration: confusion
fields:
  - label: |
      **What was the title at the top of the page where
      the bug happened?**
    field: page_title
    show if:
      code: |
        not question_id    
  - When should this fix be implemented?: maturity_level
    code: maturity_levels
    show if:
      code: |
        get_config('debug')
  - Who are you? Just tell us your name or github username, not email. This will be public.: user_contact_info
    show if:
      code: |
        get_config('debug')          
  - label: |
      **What language fix is needed?**
    field: language
    datatype: area
    rows: 4
  - label: |
      **What else would you like to tell us?**
    field: share_other_details   
    datatype: area
    required: False
---
id: logic fix
question: |
  Tell us about the logic error
decoration: confusion
fields:
  - label: |
      **What was the title at the top of the page where
      the bug happened?**
    field: page_title
    show if:
      code: |
        not question_id    
  - When should this fix be implemented?: maturity_level
    code: maturity_levels
    show if:
      code: |
        get_config('debug')
  - Who are you? Just tell us your name or github username, not email. This will be public.: user_contact_info
    show if:
      code: |
        get_config('debug')
  - label: |
      **What logic fix is needed? **
    field: logic
    datatype: area
    rows: 4
  - label: |
      **What else would you like to tell us?**
    field: share_other_details   
    datatype: area
    required: False
---
id: enhancement
question: |
  Tell us about the enhancement you propose
decoration: enhancement
fields:
  - When should this fix be implemented?: maturity_level
    code: maturity_levels
    show if:
      code: |
        get_config('debug')
  - Who are you? Just tell us your name or github username, not email. This will be public.: user_contact_info
    show if:
      code: |
        get_config('debug')          
  - label: |
      **What enhancement do you propose? **
    field: enhancement
    datatype: area
    rows: 4
  - label: |
      **What else would you like to tell us?**
    field: share_other_details   
    datatype: area
    required: False
---
template: al_how_to_get_legal_help
content: |
  If you need more help, these are free resources:

  - For help with a non-criminal legal problem in Massachusetts, use the 
  [Massachusetts Legal Resource Finder](http://masslegalhelp.org/find-legal-aid)

  - If your income is low enough, try the [Mass Legal Answers Online](http://masslao.org/) website where volunteer lawyers answer questions
  about your personal civil legal problems. 
---
id: bug
question: |
  Tell us about the bug
subquestion: |
  Please be specific about the problem you ran into. The more you tell
  us, the more we can do to try to fix it.
  
  Do not type any private information. Your bug report will be visible
  on a public website.
fields:
  - label: |
      **What was the title at the top of the page where
      the bug happened?**
    field: page_title
    show if:
      code: |
        not question_id
  - label: |
      **Tell us the steps that you followed before you noticed the problem.** [BR]
      For example: 1. I opened the interview. 2. On the first page, I put in just my first name. 3. On the second page, I put in my phone number. 4. I pressed a button to go to the next page.
    field: reproduce_bug
    datatype: area
    rows: 4
  - "**What did you expect to happen?**": bug_expected_behavior
    datatype: area
    rows: 4
  - "**What happened instead? Be specific.**": bug_details
    datatype: area
    rows: 4
  - label: |
      **What else would you like to tell us?**
    field: share_other_details   
    datatype: area
    required: False
#  - label: |
#      **Share my specific answers with an administrator**[BR]
#      You can optionally share your answers on the online form with an
#      administrator. Only two Suffolk University employees can view
#      this information. It will not be made public.
#      [BR]
#      If you say no, it may be harder for us to track down the problem,
#      but we will still try our best.
#      We will not contact you either way.
#    field: share_interview_answers
#    datatype: yesnoradio
---
id: confusing
question: |
  Tell us about your experience
subquestion: |
  Tell us about your experience. The more specific you are, the more
  helpful we can be.
  
  Do not include private information about your case. The information you
  type on this form will be visible on a public website.
fields:
  - label: |
      **What was the title at the top of the page where
      the bug happened?**
    field: page_title
  - label: |
      **What were your thoughts as you went through the confusing part of the form?**
    field: confusing_details
    datatype: area
    rows: 4
  - label: |
      **What else would you like to tell us?**
    field: share_other_details   
    datatype: area
    required: False
---
id: other thoughts
question: |
  Tell us your thoughts
subquestion: |
  Do not include private information about your case. The information you
  type on this form will be visible on a public website.
fields:
  - label: |
      **What else would you like to tell us?**
    field: other_feedback   
    datatype: area
---
id: exit
event: gentle_exit
question: |
  More help
subquestion: |
  We are sorry that we couldn't do more to help you.
  
  ${ al_how_to_get_legal_help }

buttons:
  - Exit: exit
---
id: end_results
event: end_results
question: |
  Thank you for your feedback
subquestion: |
  We appreciate you letting us know how we are doing.
  
  % if issue_url:
  If you would like to track this issue, you can [follow 
  it](${issue_url}) on GitHub.
  % endif
buttons:
  - Exit: exit
---
template: bug_report
subject: |
  % if question_id:
  ID ${ question_id }: 
  % endif
  User Bug report
  % if variable:
  (`${ variable }`)
  % endif
content: |
  &nbsp; | &nbsp;
  -------|------------------------------------
  % if defined('page_title'):
  Page title | ${ page_title }
  % endif
  Steps to reproduce | ${ reproduce_bug }
  Expected behavior | ${ bug_expected_behavior }
  What happened instead | ${ bug_details }
  Other information | ${ share_other_details }
  % if question_id:
  Question ID | ${ question_id }
  % endif
  % if variable:
  Variable being sought | ${ variable }
  % endif
  % if package_version:
  Package version | `${ package_version }`
  % endif     
  % if filename:
  Filename | `${ filename }`
  % endif
---
template: confusing_report
subject: |
  % if question_id:
  ID ${ question_id }: 
  % endif
  User feedback - confusing language
  % if variable:
  (`${ variable }`)
  % endif
content: |
  &nbsp; | &nbsp;
  -------|------------------------------------
  Page title | ${ page_title }
  What was confusing | ${ confusing_details }
  Other information | ${ share_other_details }
  % if question_id:
  Question ID | ${ question_id }
  % endif
  % if variable:
  Variable being sought | ${ variable }
  % endif  
  % if package_version:
  Package version | `${ package_version }`
  % endif   
  % if filename:
  Filename | `${ filename }`
  % endif
  
---
template: other_feedback_report
subject: |
  % if question_id:
  ID ${ question_id }: 
  % endif
  User feedback
  % if variable:
  (`${ variable }`)
  % endif
content: |
  ## User feedback:  
  ${ other_feedback }
  % if package_version:
  Package version | `${ package_version }`
  % endif     
  % if filename:
  Filename | `${ filename }`
  % endif
---
objects:
  - generic_report: DADict
---
template: generic_report[i]
subject: |
  % if question_id:
  ID ${ question_id }: 
  % endif
  Tester feedback: ${i}
  % if variable:
  (`${ variable }`)
  % endif
content: |
  &nbsp; | &nbsp;
  -------|------------------------------------
  % if question_id:
  Question ID | `${ question_id }`
  % elif defined('page_title'): 
  Page title | ${ page_title }
  % endif  
  ${i} | ${ value(i) }
  Other information | ${ share_other_details }
  % if variable:
  Variable being sought | `${ variable }`
  % endif  
  % if package_version:
  Package version | `${ package_version }`
  % endif   
  Maturity target | ${ maturity_level }
  Tester contact info | ${ user_contact_info }
  % if filename:
  Filename | `${ filename }`
  % endif  
---
########################## Send to GitHub code ##########################
code: |
  if not task_performed('sent to github', persistent=True):
    if github_user in allowed_github_users:
      issue_url = make_github_issue(github_user, github_repo, template=issue_template)
      if not issue_url and al_error_email:
        log(f"Unable to create issue on repo {github_repo}, falling back to emailing {al_error_email}")
        send_email(to=al_error_email, subject=f"{github_repo} - {issue_template.subject_as_html(trim=True)}", template=issue_template)
      elif not issue_url:
        log(f"~~~USER FEEDBACK~~~ {github_repo} -{issue_template.subject_as_html(trim=True)} - {issue_template.content_as_html(trim=True)}")
    else:
      log(f"This form is not permitted to add issues on the {github_user} account. Check your config.")
      log(f"Unable to create issue on repo {github_repo}, falling back to emailing {al_error_email}")
      send_email(to=al_error_email, subject=f"{github_repo} - {issue_template.subject_as_html(trim=True)}", template=issue_template)
    mark_task_as_performed('sent to github', persistent=True)
  send_to_github = True  